/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "string.h"
#include "stdio.h"

UART_HandleTypeDef huart1; // ESP8266 연결용 UART

/* 서버 정보 */
#define SERVER_IP "IP번호"
#define SERVER_PORT "PORT번호"

/* 함수 선언 */
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_USART1_UART_Init(void);
void ESP8266_SendCommand(char *cmd, uint32_t delay_ms);
void SendSimplePost(char *endpoint);

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_USART1_UART_Init();
    HAL_Delay(2000);

    // 1. ESP8266 초기화
    ESP8266_SendCommand("AT\r\n", 1000);
    ESP8266_SendCommand("AT+CWMODE=1\r\n", 1000); // Station 모드

    // 2. Wi-Fi 연결 (SSID, PASSWORD 필요)
    ESP8266_SendCommand("AT+CWJAP=\"SSID\",\"PASSWORD\"\r\n", 5000);

    // 3. 서버로 POST 요청 (내용 없음)
    SendSimplePost("/process/test_endpoint");

    while(1)
    {
        // 서버 응답 읽기 (간단 UART 수신)
        char rx_buf[256] = {0};
        if(HAL_UART_Receive(&huart1, (uint8_t*)rx_buf, sizeof(rx_buf)-1, 2000) == HAL_OK)
        {
            printf("ESP8266: %s\n", rx_buf);
        }
    }
}

/* ESP8266 명령 전송 */
void ESP8266_SendCommand(char *cmd, uint32_t delay_ms)
{
    HAL_UART_Transmit(&huart1, (uint8_t*)cmd, strlen(cmd), 1000);
    HAL_Delay(delay_ms);
}

/* 단순 POST 요청 전송 (데이터 없음) */
void SendSimplePost(char *endpoint)
{
    char cmd[512];
    char httpData[] = "";  // 데이터 없음

    // TCP 연결
    sprintf(cmd, "AT+CIPSTART=\"TCP\",\"%s\",%s\r\n", SERVER_IP, SERVER_PORT);
    ESP8266_SendCommand(cmd, 2000);

    // 전송할 데이터 길이
    sprintf(cmd, "AT+CIPSEND=%d\r\n", strlen(httpData) + strlen("POST ") + strlen(endpoint) + strlen(" HTTP/1.1\r\nHost: ") + strlen(SERVER_IP) + strlen("\r\nContent-Length: 0\r\n\r\n"));
    ESP8266_SendCommand(cmd, 1000);

    // HTTP POST 요청 전송 (빈 데이터)
    sprintf(cmd, "POST %s HTTP/1.1\r\nHost: %s\r\nContent-Length: 0\r\n\r\n",
            endpoint, SERVER_IP);
    ESP8266_SendCommand(cmd, 2000);

    // TCP 연결 종료
    ESP8266_SendCommand("AT+CIPCLOSE\r\n", 1000);
}

/* UART 초기화 */
static void MX_USART1_UART_Init(void)
{
    huart1.Instance = USART1;
    huart1.Init.BaudRate = 115200;
    huart1.Init.WordLength = UART_WORDLENGTH_8B;
    huart1.Init.StopBits = UART_STOPBITS_1;
    huart1.Init.Parity = UART_PARITY_NONE;
    huart1.Init.Mode = UART_MODE_TX_RX;
    huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
    huart1.Init.OverSampling = UART_OVERSAMPLING_16;
    HAL_UART_Init(&huart1);
}

/* GPIO 초기화 */
static void MX_GPIO_Init(void)
{
    __HAL_RCC_GPIOA_CLK_ENABLE();
    __HAL_RCC_GPIOB_CLK_ENABLE();
}
